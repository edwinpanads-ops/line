<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統連線中...</title>
    <!-- 引入 LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            background-color: #f9f7f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: sans-serif;
            color: #8c8c8c;
        }
        .loader {
            border: 3px solid #e0e0e0;
            border-top: 3px solid #cfa387;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { font-size: 14px; letter-spacing: 1px; }
        #error-msg { display: none; color: #d9534f; margin-top: 20px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="loader"></div>
    <p id="status-text">正在為您準備申請表...</p>
    <div id="error-msg"></div>

    <script>
        // ==========================================
        //  【設定區域】請再次填入你的 ID
        // ==========================================

        const MY_LIFF_ID = '2008869736-IyDsEMo6'; 
        const TYPEFORM_URL = 'https://gb2lbz7yoqt.typeform.com/to/pn7fIrQj'; // 例如 https://form.typeform.com/to/xxxxxx

        // 自動發送的關鍵字 (如果需要的話)
        const KEYWORD = '索取申請表單'; 
        const LINE_OA_ID = '@306ebtoz'; 

        // ==========================================
        //  【核心邏輯】
        // ==========================================

        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });

                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // --- 判斷任務 ---
                if (action === 'trigger') {
                    await handleAutoSend();
                } else {
                    await handleRedirectToForm();
                }

            } catch (err) {
                showError('系統錯誤：' + err.message);
            }
        }

        // 任務 A：自動發話 (維持不變)
        async function handleAutoSend() {
            if (!liff.isInClient()) {
                window.location.href = `https://line.me/R/oaMessage/${LINE_OA_ID}/?${encodeURIComponent(KEYWORD)}`;
                return;
            }
            try {
                await liff.sendMessages([{ type: 'text', text: KEYWORD }]);
                liff.closeWindow();
            } catch (err) {
                window.location.href = `https://line.me/R/oaMessage/${LINE_OA_ID}/?${encodeURIComponent(KEYWORD)}`;
            }
        }

        // 任務 B：跳轉表單 (★這裡是修改重點★)
        async function handleRedirectToForm() {
            try {
                const profile = await liff.getProfile();
                const userId = profile.userId;
                const displayName = profile.displayName; // 抓取暱稱

                // 組合網址：Typeform 網址 + UserID + 暱稱
                // 注意：中文暱稱必須用 encodeURIComponent 編碼，不然網址會壞掉
                const finalUrl = `${TYPEFORM_URL}#userid=${userId}&nickname=${encodeURIComponent(displayName)}`;
                
                // 跳轉
                window.location.href = finalUrl;

            } catch (err) {
                showError('無法讀取用戶資料，請稍後再試');
            }
        }

        function showError(msg) {
            document.querySelector('.loader').style.display = 'none';
            document.getElementById('status-text').style.display = 'none';
            const errDiv = document.getElementById('error-msg');
            errDiv.style.display = 'block';
            errDiv.innerText = msg;
        }

        main();
    </script>
</body>
</html>
